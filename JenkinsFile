pipeline {
    agent any

    environment {
        REACT_APP_PORT = "3000"
        BUILD_DIR = "${WORKSPACE}\\build"
        TASK_NAME = "ReactAppScheduledTask"
    }

    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Install dependencies') {
            steps {
                bat 'npm ci'
                bat 'npm install serve --no-save'
            }
        }

        stage('Run Tests') {
            steps {
                bat 'npm test -- --watchAll=false --passWithNoTests'
            }
        }

        stage('Build') {
            steps {
                bat 'npm run build'
            }
        }

        stage('Deploy React App via PowerShell') {
            steps {
                script {
                    // Remove any previous scheduled task
                    bat """
                    powershell -Command "if (Get-ScheduledTask -TaskName '${TASK_NAME}' -ErrorAction SilentlyContinue) { Unregister-ScheduledTask -TaskName '${TASK_NAME}' -Confirm:\$false }"
                    """

                    // Create a startup script in workspace
                    bat """
                    echo Start-Process npm -ArgumentList 'run','serve','-s','${BUILD_DIR}','-l','${REACT_APP_PORT}','-H','0.0.0.0' -NoNewWindow -PassThru > "${WORKSPACE}\\start-react-app.ps1"
                    """

                    // Register scheduled task to run at startup
                    bat """
                    powershell -Command "\
                    \$action = New-ScheduledTaskAction -Execute 'powershell.exe' -Argument '-File \\"${WORKSPACE}\\start-react-app.ps1\\"'; \
                    \$trigger = New-ScheduledTaskTrigger -AtStartup; \
                    \$principal = New-ScheduledTaskPrincipal -UserId 'SYSTEM' -RunLevel Highest; \
                    Register-ScheduledTask -Action \$action -Trigger \$trigger -Principal \$principal -TaskName '${TASK_NAME}' -Description 'Start React App on Windows boot' -Force"
                    """

                    // Start the app immediately
                    bat "powershell -ExecutionPolicy Bypass -File \"${WORKSPACE}\\start-react-app.ps1\""

                    echo "✅ React app deployed via PowerShell and scheduled to auto-start on reboot. Accessible externally on port ${REACT_APP_PORT}"
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline finished.'
        }
        failure {
            echo '❌ Pipeline failed. Check console logs.'
        }
        success {
            echo '✅ Pipeline succeeded. React app is running via PowerShell Scheduled Task.'
        }
    }
}
