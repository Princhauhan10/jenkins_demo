pipeline {
    agent any

    environment {
        NODE_HOME = "C:\\Program Files\\nodejs"   // Adjust if your Node.js path is different
        PATH = "${env.NODE_HOME};${env.PATH}"
        APP_HOME = "C:\\Apps\\react-build-pipeline" // Dedicated folder for your app
        PM2_HOME = "${env.APP_HOME}\\.pm2"
    }

    triggers {
        pollSCM('* * * * *') // Poll GitHub every minute (can be replaced by webhook for faster triggers)
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/Princhauhan10/jenkins_demo.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                bat "cd ${APP_HOME} && npm ci"
                bat "cd ${APP_HOME} && npm install pm2 --no-save"
                bat "cd ${APP_HOME} && npm install serve --no-save"
            }
        }

        stage('Build') {
            steps {
                bat "cd ${APP_HOME} && npm run build"
            }
        }

        stage('Deploy & Start App') {
            steps {
                script {
                    // Create PM2 home directory if not exists
                    bat "if not exist ${PM2_HOME} mkdir ${PM2_HOME}"

                    // Stop existing app if running
                    bat "cd ${APP_HOME} && npx pm2 delete react-app || exit 0"

                    // Start app serving build folder on port 3000, listen externally
                    bat "cd ${APP_HOME} && npx pm2 start serve --name react-app -- -s build -l 3000 -H 0.0.0.0"

                    // Save PM2 process list and setup auto-start on reboot
                    bat "cd ${APP_HOME} && npx pm2 save"
                }
            }
        }
    }

    post {
        success {
            echo "✅ React app deployed and running at http://<your-server-ip>:3000"
        }
        failure {
            echo "❌ Pipeline failed. Check logs."
        }
    }
}
